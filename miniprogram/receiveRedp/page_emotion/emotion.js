"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const api_js_1 = require("../../utils/request/api.js");
const request_js_1 = require("../../utils/request/request.js");
const util_js_1 = require("../../utils/util.js");
const faceBusiness_1 = require("./model/faceBusiness");
let count = 0;
const speedMaxCount = 30;
const STAY_TIME = 1000;
const isReserveDraw = false;
const canvasId = "canvas1";
const app = getApp();
let wrongTime = 0;
let pageThis;
Page({
    data: {
        titleText: "开心",
        buttonText: ["识别中...", "领取红包"],
        state: 0,
        maxWrongTime: 2,
        ModelsReady: false,
    },
    submit: util_js_1.onetap(function () {
        return new Promise((resolve, reject) => {
            const that = pageThis;
            if (that.data.state == 0) {
                reject("状态错误");
                return;
            }
            else {
                request_js_1.post(api_js_1.receive, {
                    sessionid: app.globalData.sessionid,
                    redid: that.data.redid,
                })
                    .then((res) => {
                    console.log(res);
                    let nowTime = new Date().getTime();
                    let spendTime = parseFloat(((nowTime - that.data.startTime) / 1000).toFixed(1));
                    util_js_1.handleReceive(res.data, that, resolve, reject, 1, spendTime);
                })
                    .catch((err) => {
                    console.log(err);
                    wx.showToast({
                        title: "领取失败",
                        icon: "none",
                    });
                });
            }
        });
    }),
    takePhoto() {
        const that = this;
        that.data.canvasThat.data.listener.stop();
        if (that.data.state == 0) {
            that.setData({
                state: 1,
            });
            setTimeout(() => {
                that.submit();
            }, STAY_TIME);
        }
    },
    setWrongTimeto0() {
        wrongTime = 0;
        this.setData({
            wrongTime: 0,
        });
    },
    getCanvasThat(res) {
        this.setData({
            canvasThat: res.detail.that,
            camera: res.detail.camera,
        });
    },
    handleFrame(res) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!this.data.ModelsReady)
                return;
            const that = this;
            const frame = res.detail.frame;
            if (count < speedMaxCount) {
                count++;
                return;
            }
            count = 0;
            const theFrame = {
                data: new Uint8ClampedArray(frame.data),
                width: frame.width,
                height: frame.height,
            };
            const question = that.data.titleText;
            console.log("题目是" + question);
            let result = yield faceBusiness_1.detect(theFrame, frame.width, frame.height, question);
            if (result) {
                that.takePhoto();
            }
            else {
                wrongTime++;
                console.log(wrongTime);
                if (wrongTime === that.data.maxWrongTime) {
                    that.setData({
                        wrongTime: that.data.maxWrongTime,
                    });
                }
            }
        });
    },
    onLoad(options) {
        return __awaiter(this, void 0, void 0, function* () {
            const that = this;
            pageThis = that;
            that.setData({
                nickname: options.nickname,
                titleText: options.question,
                redid: parseInt(options.redid),
                avatarUrl: options.avatarUrl,
                startTime: new Date().getTime(),
            });
            wx.showLoading({
                title: "Loading...",
            });
            yield faceBusiness_1.loadmodel(canvasId, isReserveDraw);
            wx.hideLoading();
            that.setData({
                ModelsReady: true,
            });
        });
    },
    onReady: function () {
        wx.hideShareMenu({
            menus: ["shareAppMessage", "shareTimeline"],
        });
    },
    onShow: function () { },
    onHide: function () { },
    onUnload: function () {
        const that = this;
        let listener = that.data.canvasThat.data.listener;
        if (listener)
            listener.stop();
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW1vdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImVtb3Rpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQUFBLHVEQUFxRDtBQUNyRCwrREFBc0Q7QUFDdEQsaURBQTREO0FBQzVELHVEQUF5RDtBQUN6RCxJQUFJLEtBQUssR0FBRyxDQUFDLENBQUM7QUFFZCxNQUFNLGFBQWEsR0FBRyxFQUFFLENBQUM7QUFFekIsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDO0FBQ3ZCLE1BQU0sYUFBYSxHQUFHLEtBQUssQ0FBQztBQUM1QixNQUFNLFFBQVEsR0FBRyxTQUFTLENBQUM7QUFDM0IsTUFBTSxHQUFHLEdBQUcsTUFBTSxFQUFFLENBQUM7QUFDckIsSUFBSSxTQUFTLEdBQUcsQ0FBQyxDQUFDO0FBQ2xCLElBQUksUUFHSCxDQUFDO0FBY0YsSUFBSSxDQUFzQztJQUN0QyxJQUFJLEVBQUU7UUFDRixTQUFTLEVBQUUsSUFBSTtRQUNmLFVBQVUsRUFBRSxDQUFDLFFBQVEsRUFBRSxNQUFNLENBQUM7UUFDOUIsS0FBSyxFQUFFLENBQUM7UUFDUixZQUFZLEVBQUUsQ0FBQztRQUNmLFdBQVcsRUFBRSxLQUFLO0tBQ3JCO0lBSUQsTUFBTSxFQUFFLGdCQUFNLENBQUM7UUFDWCxPQUFPLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQ25DLE1BQU0sSUFBSSxHQUFHLFFBQVEsQ0FBQztZQUN0QixJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxJQUFJLENBQUMsRUFBRTtnQkFDdEIsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUNmLE9BQU87YUFDVjtpQkFBTTtnQkFHSCxpQkFBSSxDQUFDLGdCQUFPLEVBQUU7b0JBQ1YsU0FBUyxFQUFFLEdBQUcsQ0FBQyxVQUFVLENBQUMsU0FBUztvQkFDbkMsS0FBSyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSztpQkFDekIsQ0FBQztx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UCxDQUFDO0lBRUQsTUFBTSxFQUFFLGNBQWEsQ0FBQztJQUV0QixNQUFNLEVBQUUsY0FBYSxDQUFDO0lBRXRCLFFBQVEsRUFBRTtRQUNOLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQztRQUNsQixJQUFJLFFBQVEsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDO1FBQ2xELElBQUksUUFBUTtZQUFFLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNsQyxDQUFDO0NBQ0osQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgcmVjZWl2ZSB9IGZyb20gXCIuLi8uLi91dGlscy9yZXF1ZXN0L2FwaS5qc1wiO1xyXG5pbXBvcnQgeyBwb3N0IH0gZnJvbSBcIi4uLy4uL3V0aWxzL3JlcXVlc3QvcmVxdWVzdC5qc1wiO1xyXG5pbXBvcnQgeyBvbmV0YXAsIGhhbmRsZVJlY2VpdmUgfSBmcm9tIFwiLi4vLi4vdXRpbHMvdXRpbC5qc1wiO1xyXG5pbXBvcnQgeyBsb2FkbW9kZWwsIGRldGVjdCB9IGZyb20gXCIuL21vZGVsL2ZhY2VCdXNpbmVzc1wiO1xyXG5sZXQgY291bnQgPSAwO1xyXG4vLyDmr482MOW4p+WPljHluKfov5vooYzliKTmlq1cclxuY29uc3Qgc3BlZWRNYXhDb3VudCA9IDMwO1xyXG4vKiDmjqXmlLbnuqLljIXlkI7nmoTot7Povazlu7bov58gKi9cclxuY29uc3QgU1RBWV9USU1FID0gMTAwMDtcclxuY29uc3QgaXNSZXNlcnZlRHJhdyA9IGZhbHNlO1xyXG5jb25zdCBjYW52YXNJZCA9IFwiY2FudmFzMVwiO1xyXG5jb25zdCBhcHAgPSBnZXRBcHAoKTtcclxubGV0IHdyb25nVGltZSA9IDA7XHJcbmxldCBwYWdlVGhpczogV2VjaGF0TWluaXByb2dyYW0uUGFnZS5JbnN0YW5jZTxcclxuICAgIElEYXRhLFxyXG4gICAgV2VjaGF0TWluaXByb2dyYW0uSUFueU9iamVjdFxyXG4+O1xyXG5cclxuaW50ZXJmYWNlIElEYXRhIHtcclxuICAgIHRpdGxlVGV4dDogc3RyaW5nO1xyXG4gICAgYnV0dG9uVGV4dDogc3RyaW5nW107XHJcbiAgICBzdGF0ZTogbnVtYmVyO1xyXG4gICAgbWF4V3JvbmdUaW1lOiBudW1iZXI7XHJcbiAgICBNb2RlbHNSZWFkeTogYm9vbGVhbjtcclxuXHJcbiAgICByZWRpZD86IG51bWJlcjtcclxuICAgIHN0YXJ0VGltZT86IG51bWJlcjtcclxuICAgIGNhbnZhc1RoYXQ/OiBhbnk7XHJcbn1cclxuXHJcblBhZ2U8SURhdGEsIFdlY2hhdE1pbmlwcm9ncmFtLklBbnlPYmplY3Q+KHtcclxuICAgIGRhdGE6IHtcclxuICAgICAgICB0aXRsZVRleHQ6IFwi5byA5b+DXCIsXHJcbiAgICAgICAgYnV0dG9uVGV4dDogW1wi6K+G5Yir5LitLi4uXCIsIFwi6aKG5Y+W57qi5YyFXCJdLFxyXG4gICAgICAgIHN0YXRlOiAwLCAvLzDvvJror4bliKvkuK0gICAx77ya5q2j56Gu77yM6aKG5Y+W57qi5YyFXHJcbiAgICAgICAgbWF4V3JvbmdUaW1lOiAyLFxyXG4gICAgICAgIE1vZGVsc1JlYWR5OiBmYWxzZSxcclxuICAgIH0sXHJcblxyXG4gICAgLy/mj5DkuqRcclxuICAgIC8v6K6+572u5LqG6IqC5rWB77yM5pe26Ze05Li6MXPjgIJcclxuICAgIHN1Ym1pdDogb25ldGFwKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCB0aGF0ID0gcGFnZVRoaXM7XHJcbiAgICAgICAgICAgIGlmICh0aGF0LmRhdGEuc3RhdGUgPT0gMCkge1xyXG4gICAgICAgICAgICAgICAgcmVqZWN0KFwi54q25oCB6ZSZ6K+vXCIpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgLy/lt7Lnu4/nrZTlr7npopjnm67vvIzlj6/ku6Xpooblj5ZcclxuXHJcbiAgICAgICAgICAgICAgICBwb3N0KHJlY2VpdmUsIHtcclxuICAgICAgICAgICAgICAgICAgICBzZXNzaW9uaWQ6IGFwcC5nbG9iYWxEYXRhLnNlc3Npb25pZCxcclxuICAgICAgICAgICAgICAgICAgICByZWRpZDogdGhhdC5kYXRhLnJlZGlkLFxyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICAudGhlbigocmVzKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHJlcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBub3dUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBzcGVuZFRpbWUgPSBwYXJzZUZsb2F0KFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKChub3dUaW1lIC0gdGhhdC5kYXRhLnN0YXJ0VGltZSEpIC8gMTAwMCkudG9GaXhlZCgxKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVSZWNlaXZlKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzLmRhdGEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGF0LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcGVuZFRpbWVcclxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHd4LnNob3dUb2FzdCh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aXRsZTogXCLpooblj5blpLHotKVcIixcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGljb246IFwibm9uZVwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfSksXHJcblxyXG4gICAgdGFrZVBob3RvKCkge1xyXG4gICAgICAgIGNvbnN0IHRoYXQgPSB0aGlzO1xyXG4gICAgICAgIC8vIGlmICh0aGF0LmRhdGEuaW1nUGF0aCkgcmV0dXJuXHJcbiAgICAgICAgdGhhdC5kYXRhLmNhbnZhc1RoYXQuZGF0YS5saXN0ZW5lci5zdG9wKCk7IC8v5YGc5q2i55uR5ZCs5pWw5o2u5binXHJcbiAgICAgICAgaWYgKHRoYXQuZGF0YS5zdGF0ZSA9PSAwKSB7XHJcbiAgICAgICAgICAgIHRoYXQuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgICAgICAvLyBpbWdQYXRoOiByZXMudGVtcEltYWdlUGF0aCxcclxuICAgICAgICAgICAgICAgIHN0YXRlOiAxLFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGF0LnN1Ym1pdCgpO1xyXG4gICAgICAgICAgICB9LCBTVEFZX1RJTUUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBjYW1lcmEudGFrZVBob3RvKHtcclxuICAgICAgICAvLyAgIHN1Y2Nlc3MocmVzKSB7XHJcbiAgICAgICAgLy8gICAgIGlmICh0aGF0LmRhdGEuc3RhdGUgPT0gMCkge1xyXG4gICAgICAgIC8vICAgICAgIHRoYXQuc2V0RGF0YSh7XHJcbiAgICAgICAgLy8gICAgICAgICBpbWdQYXRoOiByZXMudGVtcEltYWdlUGF0aCxcclxuICAgICAgICAvLyAgICAgICAgIHN0YXRlOiAxXHJcbiAgICAgICAgLy8gICAgICAgfSlcclxuICAgICAgICAvLyAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAvLyAgICAgICAgIHRoYXQuc3VibWl0KClcclxuICAgICAgICAvLyAgICAgICB9LCBTVEFZX1RJTUUpXHJcbiAgICAgICAgLy8gICAgIH1cclxuICAgICAgICAvLyAgIH1cclxuICAgICAgICAvLyB9KVxyXG4gICAgfSxcclxuXHJcbiAgICBzZXRXcm9uZ1RpbWV0bzAoKSB7XHJcbiAgICAgICAgd3JvbmdUaW1lID0gMDtcclxuICAgICAgICB0aGlzLnNldERhdGEoe1xyXG4gICAgICAgICAgICB3cm9uZ1RpbWU6IDAsXHJcbiAgICAgICAgfSk7XHJcbiAgICB9LFxyXG5cclxuICAgIGdldENhbnZhc1RoYXQocmVzOiBhbnkpIHtcclxuICAgICAgICB0aGlzLnNldERhdGEoe1xyXG4gICAgICAgICAgICBjYW52YXNUaGF0OiByZXMuZGV0YWlsLnRoYXQsXHJcbiAgICAgICAgICAgIGNhbWVyYTogcmVzLmRldGFpbC5jYW1lcmEsXHJcbiAgICAgICAgfSk7XHJcbiAgICB9LFxyXG5cclxuICAgIGFzeW5jIGhhbmRsZUZyYW1lKHJlczoge1xyXG4gICAgICAgIGRldGFpbDogeyBmcmFtZTogV2VjaGF0TWluaXByb2dyYW0uT25DYW1lcmFGcmFtZUNhbGxiYWNrUmVzdWx0IH07XHJcbiAgICB9KSB7XHJcbiAgICAgICAgaWYgKCF0aGlzLmRhdGEuTW9kZWxzUmVhZHkpIHJldHVybjtcclxuICAgICAgICBjb25zdCB0aGF0ID0gdGhpcztcclxuICAgICAgICBjb25zdCBmcmFtZSA9IHJlcy5kZXRhaWwuZnJhbWU7XHJcblxyXG4gICAgICAgIGlmIChjb3VudCA8IHNwZWVkTWF4Q291bnQpIHtcclxuICAgICAgICAgICAgY291bnQrKztcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb3VudCA9IDA7XHJcbiAgICAgICAgY29uc3QgdGhlRnJhbWUgPSB7XHJcbiAgICAgICAgICAgIGRhdGE6IG5ldyBVaW50OENsYW1wZWRBcnJheShmcmFtZS5kYXRhKSxcclxuICAgICAgICAgICAgd2lkdGg6IGZyYW1lLndpZHRoLFxyXG4gICAgICAgICAgICBoZWlnaHQ6IGZyYW1lLmhlaWdodCxcclxuICAgICAgICB9O1xyXG4gICAgICAgIC8vIHByb2Nlc3NcclxuICAgICAgICBjb25zdCBxdWVzdGlvbiA9IHRoYXQuZGF0YS50aXRsZVRleHQ7XHJcbiAgICAgICAgY29uc29sZS5sb2coXCLpopjnm67mmK9cIiArIHF1ZXN0aW9uKTtcclxuICAgICAgICBsZXQgcmVzdWx0ID0gYXdhaXQgZGV0ZWN0KFxyXG4gICAgICAgICAgICB0aGVGcmFtZSxcclxuICAgICAgICAgICAgZnJhbWUud2lkdGgsXHJcbiAgICAgICAgICAgIGZyYW1lLmhlaWdodCxcclxuICAgICAgICAgICAgcXVlc3Rpb25cclxuICAgICAgICApO1xyXG4gICAgICAgIGlmIChyZXN1bHQpIHtcclxuICAgICAgICAgICAgdGhhdC50YWtlUGhvdG8oKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB3cm9uZ1RpbWUrKztcclxuICAgICAgICAgICAgY29uc29sZS5sb2cod3JvbmdUaW1lKTtcclxuICAgICAgICAgICAgaWYgKHdyb25nVGltZSA9PT0gdGhhdC5kYXRhLm1heFdyb25nVGltZSkge1xyXG4gICAgICAgICAgICAgICAgdGhhdC5zZXREYXRhKHtcclxuICAgICAgICAgICAgICAgICAgICB3cm9uZ1RpbWU6IHRoYXQuZGF0YS5tYXhXcm9uZ1RpbWUsXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH0sXHJcblxyXG4gICAgYXN5bmMgb25Mb2FkKG9wdGlvbnM6IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIH0pIHtcclxuICAgICAgICBjb25zdCB0aGF0ID0gdGhpcztcclxuICAgICAgICBwYWdlVGhpcyA9IHRoYXQ7XHJcbiAgICAgICAgdGhhdC5zZXREYXRhKHtcclxuICAgICAgICAgICAgbmlja25hbWU6IG9wdGlvbnMubmlja25hbWUsXHJcbiAgICAgICAgICAgIHRpdGxlVGV4dDogb3B0aW9ucy5xdWVzdGlvbixcclxuICAgICAgICAgICAgcmVkaWQ6IHBhcnNlSW50KG9wdGlvbnMucmVkaWQpLFxyXG4gICAgICAgICAgICBhdmF0YXJVcmw6IG9wdGlvbnMuYXZhdGFyVXJsLFxyXG4gICAgICAgICAgICBzdGFydFRpbWU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLFxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB3eC5zaG93TG9hZGluZyh7XHJcbiAgICAgICAgICAgIHRpdGxlOiBcIkxvYWRpbmcuLi5cIixcclxuICAgICAgICB9KTtcclxuICAgICAgICBhd2FpdCBsb2FkbW9kZWwoY2FudmFzSWQsIGlzUmVzZXJ2ZURyYXcpO1xyXG4gICAgICAgIHd4LmhpZGVMb2FkaW5nKCk7XHJcbiAgICAgICAgdGhhdC5zZXREYXRhKHtcclxuICAgICAgICAgICAgTW9kZWxzUmVhZHk6IHRydWUsXHJcbiAgICAgICAgfSk7XHJcbiAgICB9LFxyXG5cclxuICAgIG9uUmVhZHk6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB3eC5oaWRlU2hhcmVNZW51KHtcclxuICAgICAgICAgICAgbWVudXM6IFtcInNoYXJlQXBwTWVzc2FnZVwiLCBcInNoYXJlVGltZWxpbmVcIl0sXHJcbiAgICAgICAgfSk7XHJcbiAgICB9LFxyXG5cclxuICAgIG9uU2hvdzogZnVuY3Rpb24gKCkge30sXHJcblxyXG4gICAgb25IaWRlOiBmdW5jdGlvbiAoKSB7fSxcclxuXHJcbiAgICBvblVubG9hZDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIGNvbnN0IHRoYXQgPSB0aGlzO1xyXG4gICAgICAgIGxldCBsaXN0ZW5lciA9IHRoYXQuZGF0YS5jYW52YXNUaGF0LmRhdGEubGlzdGVuZXI7XHJcbiAgICAgICAgaWYgKGxpc3RlbmVyKSBsaXN0ZW5lci5zdG9wKCk7XHJcbiAgICB9LFxyXG59KTtcclxuIl19