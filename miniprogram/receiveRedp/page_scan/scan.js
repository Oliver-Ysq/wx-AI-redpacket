"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const api_js_1 = require("../../utils/request/api.js");
const request_js_1 = require("../../utils/request/request.js");
const util_js_1 = require("../../utils/util.js");
const app = getApp();
const STAY_TIME = 1200;
let pageThis;
Page({
    data: {
        bottomTexts: ["识别中...", "识别不成功，再试试吧", "挑战成功"],
        imgPath: "",
        state: -1,
    },
    onCameraError(err) {
        console.log(err);
        wx.showToast({ title: 'camera error', icon: "none" });
    },
    submit: util_js_1.onetap(function () {
        return new Promise((resolve, reject) => {
            const that = pageThis;
            if (that.data.state !== 2) {
                reject("状态错误");
                return;
            }
            else {
                request_js_1.post(api_js_1.receive, {
                    sessionid: app.globalData.sessionid,
                    redid: that.data.redid,
                })
                    .then((res) => {
                    console.log(res);
                    let nowTime = new Date().getTime();
                    let spendTime = parseFloat(((nowTime - that.data.startTime) /
                        1000).toFixed(1));
                    util_js_1.handleReceive(res.data, that, resolve, reject, 2, spendTime);
                })
                    .catch((err) => {
                    console.log(err);
                    wx.showToast({
                        title: "领取失败",
                        icon: "none",
                    });
                });
            }
        });
    }),
    takePhoto() {
        const that = this;
        that.data.camera.takePhoto({
            success(res) {
                if (that.data.state === -1 || that.data.state === 1) {
                    that.setData({
                        imgPath: res.tempImagePath,
                        state: 0
                    }, () => {
                        that.checkImg(res.tempImagePath);
                    });
                }
            }
        });
    },
    restart() {
        const that = this;
        that.setData({
            state: -1,
            imgPath: ""
        });
    },
    judgeResult(data) {
        const that = this;
        if (data.tabs && data.tabs[0] && data.tabs[0].link_keyword && data.tabs[0].link_keyword.includes(that.data.titleText)) {
            that.setData({ state: 2 }, () => {
                setTimeout(() => {
                    that.submit();
                }, STAY_TIME);
            });
        }
        else {
            that.setData({ state: 1 });
        }
    },
    checkImg(tempImagePath) {
        const that = this;
        let data = { "mode": 1, "src": 3 };
        wx.uploadFile({
            filePath: tempImagePath,
            name: 'file',
            url: 'https://mp.weixin.qq.com/wxamusic/apidebug_imagequery?action=scan_cover_img&r=' + JSON.stringify(data),
            success(res1) {
                let req_key = JSON.parse(res1.data)['req_key'];
                console.log('req_key：', req_key);
                wx.request({
                    url: 'https://mp.weixin.qq.com/wxamusic/apidebug_imagequery?action=retrieval_by_reqkey&r=' + JSON.stringify({ "req_key": req_key }),
                    method: "GET",
                    success(res) {
                        console.log('预测结果：', res.data);
                        that.judgeResult(res.data);
                    },
                    fail: (err) => {
                        wx.showToast({ title: "上传失败，请重试", icon: "none" });
                        that.setData({ state: 1 });
                        console.log(err);
                    }
                });
            },
            fail: (err) => {
                wx.showToast({ title: "上传失败，请重试", icon: "none" });
                that.setData({ state: 1 });
                console.log(err);
            }
        });
    },
    onLoad: function (options) {
        console.log(options);
        const that = this;
        pageThis = that;
        that.setData({
            nickname: options.nickname,
            titleText: options.question,
            avatarUrl: options.avatarUrl,
            redid: parseInt(options.redid),
            startTime: new Date().getTime(),
        });
        wx.hideShareMenu({ menus: ["shareAppMessage", "shareTimeline"] });
    },
    onReady: function () {
        const that = this;
        const camera = wx.createCameraContext();
        that.setData({
            cameraHeight: app.globalData.appHeight * 0.79,
            cameraWidth: Math.floor((app.globalData.appWidth * 0.933) / 32) * 32,
            camera,
        });
    },
    onShow: function () { },
    onHide: function () { },
    onUnload: function () { },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Nhbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInNjYW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFDQSx1REFBcUQ7QUFDckQsK0RBQXNEO0FBQ3RELGlEQUE0RDtBQUM1RCxNQUFNLEdBQUcsR0FBRyxNQUFNLEVBQUUsQ0FBQztBQUNyQixNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUM7QUFDdkIsSUFBSSxRQUdILENBQUM7QUFnQkYsSUFBSSxDQUFzQztJQUN0QyxJQUFJLEVBQUU7UUFDRixXQUFXLEVBQUUsQ0FBQyxRQUFRLEVBQUUsWUFBWSxFQUFFLE1BQU0sQ0FBQztRQUM3QyxPQUFPLEVBQUUsRUFBRTtRQUNYLEtBQUssRUFBRSxDQUFDLENBQUM7S0FRWjtJQUVELGFBQWEsQ0FBQyxHQUFRO1FBQ2xCLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUE7UUFDaEIsRUFBRSxDQUFDLFNBQVMsQ0FBQyxFQUFFLEtBQUssRUFBRSxjQUFjLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUE7SUFDekQsQ0FBQztJQUlELE1BQU0sRUFBRSxnQkFBTSxDQUFDO1FBQ1gsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUNuQyxNQUFNLElBQUksR0FBRyxRQUFRLENBQUM7WUFDdEIsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssS0FBSyxDQUFDLEVBQUU7Z0JBQ3ZCLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztnQkFDZixPQUFPO2FBQ1Y7aUJBQU07Z0JBRUgsaUJBQUksQ0FBQyxnQkFBTyxFQUFFO29CQUNWLFNBQVMsRUFBRSxHQUFHLENBQUMsVUFBVSxDQUFDLFNBQVM7b0JBQ25DLEtBQUssRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUs7aUJBQ3pCLENBQUM7cUJBQ0csSUFBSSxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUU7b0JBQ1YsT0FBTyxDQUFDLEdB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QUFjLENBQUM7SUFDdkIsUUFBUSxFQUFFLGNBQWMsQ0FBQztDQUM1QixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBpbXBvcnQgeyByZWNlaXZlLCBzYW93dSB9IGZyb20gXCIuLi8uLi91dGlscy9yZXF1ZXN0L2FwaS5qc1wiO1xyXG5pbXBvcnQgeyByZWNlaXZlIH0gZnJvbSBcIi4uLy4uL3V0aWxzL3JlcXVlc3QvYXBpLmpzXCI7XHJcbmltcG9ydCB7IHBvc3QgfSBmcm9tIFwiLi4vLi4vdXRpbHMvcmVxdWVzdC9yZXF1ZXN0LmpzXCI7XHJcbmltcG9ydCB7IG9uZXRhcCwgaGFuZGxlUmVjZWl2ZSB9IGZyb20gXCIuLi8uLi91dGlscy91dGlsLmpzXCI7XHJcbmNvbnN0IGFwcCA9IGdldEFwcCgpO1xyXG5jb25zdCBTVEFZX1RJTUUgPSAxMjAwO1xyXG5sZXQgcGFnZVRoaXM6IFdlY2hhdE1pbmlwcm9ncmFtLlBhZ2UuSW5zdGFuY2U8XHJcbiAgICBJRGF0YSxcclxuICAgIFdlY2hhdE1pbmlwcm9ncmFtLklBbnlPYmplY3RcclxuPjtcclxuXHJcbmludGVyZmFjZSBJRGF0YSB7XHJcbiAgICBib3R0b21UZXh0czogc3RyaW5nW107XHJcbiAgICBzdGF0ZTogbnVtYmVyO1xyXG4gICAgaW1nUGF0aDogc3RyaW5nO1xyXG5cclxuICAgIHRpdGxlVGV4dD86IHN0cmluZztcclxuICAgIGF2YXRhclVybD86IHN0cmluZztcclxuICAgIHJlZGlkPzogbnVtYmVyO1xyXG4gICAgYWN0aXZlVHlwZT86IG51bWJlcjtcclxuICAgIGFjdGlvblR5cGU/OiBudW1iZXI7XHJcbiAgICBzdGFydFRpbWU/OiBudW1iZXI7XHJcbiAgICBjYW1lcmE/OiBhbnk7XHJcbn1cclxuXHJcblBhZ2U8SURhdGEsIFdlY2hhdE1pbmlwcm9ncmFtLklBbnlPYmplY3Q+KHtcclxuICAgIGRhdGE6IHtcclxuICAgICAgICBib3R0b21UZXh0czogW1wi6K+G5Yir5LitLi4uXCIsIFwi6K+G5Yir5LiN5oiQ5Yqf77yM5YaN6K+V6K+V5ZCnXCIsIFwi5oyR5oiY5oiQ5YqfXCJdLFxyXG4gICAgICAgIGltZ1BhdGg6IFwiXCIsXHJcbiAgICAgICAgc3RhdGU6IC0xLFxyXG4gICAgICAgIC8qKioqKioqKioqIFxyXG4gICAgICAgIHN0YXRlOlxyXG4gICAgICAgIC0x77ya5Yid5aeL54q25oCBICAgIFxyXG4gICAgICAgICAw77ya6K+G5Yir5LitICAgXHJcbiAgICAgICAgIDHvvJrlpLHotKXvvIzph43or5UgICBcclxuICAgICAgICAgMu+8muato+ehru+8jOmihuWPlue6ouWMhVxyXG4gICAgICAgICoqKioqKioqKioqKi9cclxuICAgIH0sXHJcblxyXG4gICAgb25DYW1lcmFFcnJvcihlcnI6IGFueSkge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKGVycilcclxuICAgICAgICB3eC5zaG93VG9hc3QoeyB0aXRsZTogJ2NhbWVyYSBlcnJvcicsIGljb246IFwibm9uZVwiIH0pXHJcbiAgICB9LFxyXG5cclxuICAgIC8v5o+Q5LqkXHJcbiAgICAvL+atpOWkhOS9v+eUqOS6hm9uZXRhcOaWueazle+8jOmYsuatouWkmuasoeeCueaMieOAglxyXG4gICAgc3VibWl0OiBvbmV0YXAoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHRoYXQgPSBwYWdlVGhpcztcclxuICAgICAgICAgICAgaWYgKHRoYXQuZGF0YS5zdGF0ZSAhPT0gMikge1xyXG4gICAgICAgICAgICAgICAgcmVqZWN0KFwi54q25oCB6ZSZ6K+vXCIpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgLy/lt7Lnu4/nrZTlr7npopjnm67vvIzlj6/ku6Xpooblj5ZcclxuICAgICAgICAgICAgICAgIHBvc3QocmVjZWl2ZSwge1xyXG4gICAgICAgICAgICAgICAgICAgIHNlc3Npb25pZDogYXBwLmdsb2JhbERhdGEuc2Vzc2lvbmlkLFxyXG4gICAgICAgICAgICAgICAgICAgIHJlZGlkOiB0aGF0LmRhdGEucmVkaWQsXHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKChyZXMpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2cocmVzKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IG5vd1RpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHNwZW5kVGltZSA9IHBhcnNlRmxvYXQoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKG5vd1RpbWUgLSAodGhhdC5kYXRhLnN0YXJ0VGltZSBhcyBudW1iZXIpKSAvXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMTAwMFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKS50b0ZpeGVkKDEpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZVJlY2VpdmUoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXMuZGF0YSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgMixcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNwZW5kVGltZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgLmNhdGNoKChlcnIpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgd3guc2hvd1RvYXN0KHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpdGxlOiBcIumihuWPluWksei0pVwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWNvbjogXCJub25lXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KSxcclxuXHJcbiAgICB0YWtlUGhvdG8oKSB7XHJcbiAgICAgICAgY29uc3QgdGhhdCA9IHRoaXM7XHJcbiAgICAgICAgdGhhdC5kYXRhLmNhbWVyYS50YWtlUGhvdG8oe1xyXG4gICAgICAgICAgICBzdWNjZXNzKHJlczogYW55KSB7XHJcbiAgICAgICAgICAgICAgICBpZiAodGhhdC5kYXRhLnN0YXRlID09PSAtMSB8fCB0aGF0LmRhdGEuc3RhdGUgPT09IDEpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGF0LnNldERhdGEoe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpbWdQYXRoOiByZXMudGVtcEltYWdlUGF0aCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGU6IDBcclxuICAgICAgICAgICAgICAgICAgICB9LCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuY2hlY2tJbWcocmVzLnRlbXBJbWFnZVBhdGgpXHJcbiAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pXHJcbiAgICB9LFxyXG5cclxuICAgIHJlc3RhcnQoKSB7XHJcbiAgICAgICAgY29uc3QgdGhhdCA9IHRoaXNcclxuICAgICAgICB0aGF0LnNldERhdGEoe1xyXG4gICAgICAgICAgICBzdGF0ZTogLTEsXHJcbiAgICAgICAgICAgIGltZ1BhdGg6IFwiXCJcclxuICAgICAgICB9KVxyXG4gICAgfSxcclxuXHJcbiAgICBqdWRnZVJlc3VsdChkYXRhOiBhbnkpIHtcclxuICAgICAgICBjb25zdCB0aGF0ID0gdGhpc1xyXG4gICAgICAgIGlmIChkYXRhLnRhYnMgJiYgZGF0YS50YWJzWzBdICYmIGRhdGEudGFic1swXS5saW5rX2tleXdvcmQgJiYgZGF0YS50YWJzWzBdLmxpbmtfa2V5d29yZC5pbmNsdWRlcyh0aGF0LmRhdGEudGl0bGVUZXh0KSkge1xyXG4gICAgICAgICAgICB0aGF0LnNldERhdGEoeyBzdGF0ZTogMiB9LCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICB0aGF0LnN1Ym1pdCgpO1xyXG4gICAgICAgICAgICAgICAgfSwgU1RBWV9USU1FKVxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoYXQuc2V0RGF0YSh7IHN0YXRlOiAxIH0pXHJcbiAgICAgICAgfVxyXG4gICAgfSxcclxuXHJcblxyXG4gICAgY2hlY2tJbWcodGVtcEltYWdlUGF0aDogc3RyaW5nKSB7XHJcbiAgICAgICAgY29uc3QgdGhhdCA9IHRoaXNcclxuICAgICAgICBsZXQgZGF0YSA9IHsgXCJtb2RlXCI6IDEsIFwic3JjXCI6IDMgfTtcclxuICAgICAgICB3eC51cGxvYWRGaWxlKHtcclxuICAgICAgICAgICAgZmlsZVBhdGg6IHRlbXBJbWFnZVBhdGgsXHJcbiAgICAgICAgICAgIG5hbWU6ICdmaWxlJyxcclxuICAgICAgICAgICAgdXJsOiAnaHR0cHM6Ly9tcC53ZWl4aW4ucXEuY29tL3d4YW11c2ljL2FwaWRlYnVnX2ltYWdlcXVlcnk/YWN0aW9uPXNjYW5fY292ZXJfaW1nJnI9JyArIEpTT04uc3RyaW5naWZ5KGRhdGEpLFxyXG4gICAgICAgICAgICBzdWNjZXNzKHJlczEpIHtcclxuICAgICAgICAgICAgICAgIGxldCByZXFfa2V5ID0gSlNPTi5wYXJzZShyZXMxLmRhdGEpWydyZXFfa2V5J107XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygncmVxX2tlee+8micsIHJlcV9rZXkpO1xyXG4gICAgICAgICAgICAgICAgd3gucmVxdWVzdCh7XHJcbiAgICAgICAgICAgICAgICAgICAgdXJsOiAnaHR0cHM6Ly9tcC53ZWl4aW4ucXEuY29tL3d4YW11c2ljL2FwaWRlYnVnX2ltYWdlcXVlcnk/YWN0aW9uPXJldHJpZXZhbF9ieV9yZXFrZXkmcj0nICsgSlNPTi5zdHJpbmdpZnkoeyBcInJlcV9rZXlcIjogcmVxX2tleSB9KSxcclxuICAgICAgICAgICAgICAgICAgICBtZXRob2Q6IFwiR0VUXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgc3VjY2VzcyhyZXMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ+mihOa1i+e7k+aenO+8micsIHJlcy5kYXRhKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5qdWRnZVJlc3VsdChyZXMuZGF0YSlcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIGZhaWw6IChlcnIpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgd3guc2hvd1RvYXN0KHsgdGl0bGU6IFwi5LiK5Lyg5aSx6LSl77yM6K+36YeN6K+VXCIsIGljb246IFwibm9uZVwiIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGF0LnNldERhdGEoeyBzdGF0ZTogMSB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgZmFpbDogKGVycikgPT4ge1xyXG4gICAgICAgICAgICAgICAgd3guc2hvd1RvYXN0KHsgdGl0bGU6IFwi5LiK5Lyg5aSx6LSl77yM6K+36YeN6K+VXCIsIGljb246IFwibm9uZVwiIH0pO1xyXG4gICAgICAgICAgICAgICAgdGhhdC5zZXREYXRhKHsgc3RhdGU6IDEgfSk7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnIpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9LFxyXG5cclxuXHJcbiAgICBvbkxvYWQ6IGZ1bmN0aW9uIChvcHRpb25zOiB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB9KSB7XHJcbiAgICAgICAgY29uc29sZS5sb2cob3B0aW9ucyk7XHJcbiAgICAgICAgY29uc3QgdGhhdCA9IHRoaXM7XHJcbiAgICAgICAgcGFnZVRoaXMgPSB0aGF0XHJcbiAgICAgICAgdGhhdC5zZXREYXRhKHtcclxuICAgICAgICAgICAgbmlja25hbWU6IG9wdGlvbnMubmlja25hbWUsXHJcbiAgICAgICAgICAgIHRpdGxlVGV4dDogb3B0aW9ucy5xdWVzdGlvbixcclxuICAgICAgICAgICAgYXZhdGFyVXJsOiBvcHRpb25zLmF2YXRhclVybCxcclxuICAgICAgICAgICAgcmVkaWQ6IHBhcnNlSW50KG9wdGlvbnMucmVkaWQpLFxyXG4gICAgICAgICAgICBzdGFydFRpbWU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLFxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHd4LmhpZGVTaGFyZU1lbnUoeyBtZW51czogW1wic2hhcmVBcHBNZXNzYWdlXCIsIFwic2hhcmVUaW1lbGluZVwiXSB9KTtcclxuICAgIH0sXHJcblxyXG4gICAgb25SZWFkeTogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIGNvbnN0IHRoYXQgPSB0aGlzO1xyXG4gICAgICAgIGNvbnN0IGNhbWVyYSA9IHd4LmNyZWF0ZUNhbWVyYUNvbnRleHQoKTtcclxuICAgICAgICB0aGF0LnNldERhdGEoe1xyXG4gICAgICAgICAgICBjYW1lcmFIZWlnaHQ6IGFwcC5nbG9iYWxEYXRhLmFwcEhlaWdodCAqIDAuNzksXHJcbiAgICAgICAgICAgIGNhbWVyYVdpZHRoOlxyXG4gICAgICAgICAgICAgICAgTWF0aC5mbG9vcigoYXBwLmdsb2JhbERhdGEuYXBwV2lkdGggKiAwLjkzMykgLyAzMikgKiAzMixcclxuICAgICAgICAgICAgY2FtZXJhLFxyXG4gICAgICAgIH0pO1xyXG4gICAgfSxcclxuICAgIG9uU2hvdzogZnVuY3Rpb24gKCkgeyB9LFxyXG4gICAgb25IaWRlOiBmdW5jdGlvbiAoKSB7IH0sXHJcbiAgICBvblVubG9hZDogZnVuY3Rpb24gKCkgeyB9LFxyXG59KTtcclxuIl19